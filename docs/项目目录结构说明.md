# 📁 AI智能客服问答系统 - 项目目录结构说明

## 📊 整体结构概览

```
ai_lemo_qa/
├── 📂 app/                          # 后端应用核心目录
│   ├── 📂 api/                      # API路由层
│   ├── 📂 core/                     # 核心配置模块
│   ├── 📂 models/                   # 数据库模型
│   ├── 📂 schemas/                  # Pydantic数据验证模型
│   ├── 📂 services/                 # 业务逻辑服务层
│   └── 📄 main.py                   # FastAPI应用入口
│
├── 📂 frontend/                     # Vue 3前端应用
│   ├── 📂 src/                      # 源代码目录
│   ├── 📂 public/                   # 静态资源
│   ├── 📄 package.json              # 前端依赖配置
│   └── 📄 vite.config.js            # Vite构建配置
│
├── 📂 config/                       # 配置文件目录
│   ├── 📄 milvus.yaml               # Milvus向量数据库配置
│   └── 📂 searxng/                  # SearXNG搜索引擎配置
│
├── 📂 scripts/                      # 工具脚本
│   ├── 📄 init.sql                  # 数据库初始化SQL
│   └── 📄 init_milvus.py            # Milvus初始化脚本
│
├── 📂 docs/                         # 项目文档
│   ├── 📄 需求文档.md                # 项目需求规格说明
│   ├── 📄 开发计划.md                # 开发进度和计划
│   ├── 📄 Agent使用指南.md           # Agent架构使用指南
│   └── 📄 项目目录结构说明.md         # 本文档
│
├── 📂 logs/                         # 日志文件目录
│   └── 📄 app_*.log                 # 按日期命名的日志文件
│
├── 📄 docker-compose.yml            # Docker容器编排配置
├── 📄 requirements.txt              # Python依赖包列表
├── 📄 .env                          # 环境变量配置（不提交到Git）
├── 📄 .gitignore                    # Git忽略文件配置
├── 📄 README.md                     # 项目说明文档
├── 📄 start.sh                      # 服务启动脚本
├── 📄 stop.sh                       # 服务停止脚本
└── 📄 restart.sh                    # 服务重启脚本
```

---

## 📂 核心目录详解

### 1️⃣ app/ - 后端应用核心

这是Python后端应用的主目录，基于FastAPI框架构建。

#### 📂 app/api/ - API路由层

```
app/api/
├── __init__.py
├── deps.py                          # 依赖注入（数据库会话等）
└── v1/                              # API版本1
    ├── __init__.py
    ├── chat.py                      # 💬 聊天问答接口
    ├── knowledge.py                 # 📚 知识库管理接口
    └── feedback.py                  # 👍 用户反馈接口
```

**核心接口**：
- `POST /api/v1/chat` - 智能问答
- `POST /api/v1/knowledge` - 添加知识
- `GET /api/v1/knowledge` - 获取知识列表
- `PUT /api/v1/knowledge/{id}` - 更新知识
- `DELETE /api/v1/knowledge/{id}` - 删除知识
- `POST /api/v1/feedback` - 提交反馈

#### 📂 app/core/ - 核心配置模块

```
app/core/
├── __init__.py
├── config.py                        # ⚙️ 配置管理（环境变量加载）
├── database.py                      # 🗄️ 数据库连接管理
└── logger.py                        # 📝 日志配置（Loguru）
```

**config.py 包含的配置**：
- 数据库连接（PostgreSQL、Redis）
- Milvus向量数据库配置
- Ollama LLM配置
- SearXNG搜索引擎配置
- 和风天气API配置
- Agent行为参数

#### 📂 app/models/ - 数据库模型

```
app/models/
├── __init__.py
├── knowledge.py                     # 📚 知识库数据模型
├── conversation.py                  # 💬 对话历史模型
└── feedback.py                      # 👍 用户反馈模型
```

使用SQLAlchemy ORM定义数据库表结构。

#### 📂 app/schemas/ - Pydantic数据验证模型

```
app/schemas/
├── __init__.py
├── chat.py                          # 聊天请求/响应模型
├── knowledge.py                     # 知识库数据模型
└── feedback.py                      # 反馈数据模型
```

用于API请求/响应的数据验证和序列化。

#### 📂 app/services/ - 业务逻辑服务层 ⭐

这是系统的核心业务逻辑层，包含多个关键服务：

```
app/services/
├── __init__.py
├── chat.py                          # 🧠 问答服务主控制器
├── embedding.py                     # 🔢 文本向量化服务（Ollama Embedding）
├── milvus.py                        # 🔍 向量检索服务（Milvus）
├── llm.py                           # 🤖 大语言模型服务（Qwen3-8B）
├── search.py                        # 🌐 网络搜索服务（SearXNG）
├── custom_tools.py                  # 🛠️ 自定义工具（日期、计算器、知识库）
│
├── 📂 agents/                       # 多Agent架构目录 ⭐⭐⭐
│   ├── __init__.py
│   ├── base.py                      # Agent基类接口定义
│   ├── manager.py                   # 🎯 Agent管理器（自动路由）
│   ├── general_agent.py             # 🤖 通用助手Agent（原LangChain Agent）
│   └── weather_agent.py             # 🌤️ 天气专家Agent（工具链串联）
│
└── 📂 tools/                        # 专业工具目录
    ├── __init__.py
    └── weather_tool.py              # 🌤️ 和风天气API封装
```

**服务层核心职责**：
- **chat.py**: 问答流程编排，Agent路由调度
- **embedding.py**: 调用Ollama将文本转为768维向量
- **milvus.py**: 向量存储、检索、相似度搜索
- **llm.py**: 调用Qwen3-8B生成答案
- **search.py**: 调用SearXNG进行网络搜索
- **agents/**: 多Agent架构，支持自动路由到专业Agent

---

### 2️⃣ frontend/ - Vue 3前端应用

```
frontend/
├── src/
│   ├── api/                         # API接口封装
│   │   └── index.js                 # Axios HTTP客户端
│   │
│   ├── views/                       # 页面视图
│   │   ├── ChatView.vue             # 💬 聊天界面（含问题历史）
│   │   └── KnowledgeView.vue        # 📚 知识库管理界面
│   │
│   ├── router/                      # 路由配置
│   │   └── index.js                 # Vue Router路由表
│   │
│   ├── App.vue                      # 根组件
│   └── main.js                      # 应用入口
│
├── public/                          # 静态资源
├── index.html                       # HTML模板
├── package.json                     # npm依赖配置
├── vite.config.js                   # Vite构建配置（含代理）
└── README.md                        # 前端文档
```

**技术栈**：
- Vue 3（Composition API）
- Element Plus（UI组件库）
- Vue Router 4
- Axios
- Vite

---

### 3️⃣ config/ - 配置文件

```
config/
├── milvus.yaml                      # Milvus向量数据库配置
└── searxng/
    └── settings.yml                 # SearXNG搜索引擎配置
```

---

### 4️⃣ scripts/ - 工具脚本

```
scripts/
├── init.sql                         # PostgreSQL数据库初始化SQL
└── init_milvus.py                   # Milvus向量集合初始化脚本
```

---

### 5️⃣ docs/ - 项目文档

```
docs/
├── 需求文档.md                       # 项目需求规格说明
├── 开发计划.md                       # 开发阶段和进度追踪
├── Agent使用指南.md                  # 多Agent架构使用指南
└── 项目目录结构说明.md                # 本文档
```

---

## 🔧 配置文件说明

### .env - 环境变量配置

```bash
# 数据库配置
DATABASE_URL=postgresql+asyncpg://postgres:password@localhost:5432/ai_lemo_qa
REDIS_URL=redis://localhost:6379/0

# Milvus配置
MILVUS_HOST=localhost
MILVUS_PORT=19530
MILVUS_COLLECTION=knowledge_vectors

# Ollama配置
OLLAMA_BASE_URL=http://localhost:11434
OLLAMA_MODEL=qwen2.5:latest
OLLAMA_EMBEDDING_MODEL=nomic-embed-text

# SearXNG配置
SEARXNG_URL=http://localhost:8081

# 和风天气API配置
QWEATHER_API_KEY=your_api_key_here
QWEATHER_API_HOST=your_custom_host_here

# Agent配置
AGENT_VERBOSE=true
AGENT_MAX_ITERATIONS=5
AGENT_MAX_EXECUTION_TIME=60
```

### docker-compose.yml - Docker容器编排

包含以下服务：
- **postgres**: PostgreSQL 16数据库
- **redis**: Redis 7缓存
- **etcd**: Milvus依赖的元数据存储
- **minio**: Milvus依赖的对象存储
- **milvus**: 向量数据库
- **attu**: Milvus Web管理界面
- **searxng**: 元搜索引擎

---

## 🚀 启动脚本说明

### start.sh - 启动服务

```bash
./start.sh
```

**功能**：
- 停止现有服务
- 激活Python虚拟环境
- 检查并安装依赖
- 启动Uvicorn服务器（后台运行）
- 健康检查
- 显示服务信息

### stop.sh - 停止服务

```bash
./stop.sh
```

**功能**：
- 查找占用8080端口的进程
- 优雅地停止服务

### restart.sh - 重启服务

```bash
./restart.sh
```

**功能**：
- 先执行stop.sh
- 等待2秒
- 再执行start.sh

---

## 📊 数据流图

### 问答流程

```
用户提问
    ↓
[ChatView.vue] 前端界面
    ↓ HTTP POST
[/api/v1/chat] FastAPI接口
    ↓
[chat.py] 问答服务
    ├─→ [embedding.py] 向量化
    │      ↓
    ├─→ [milvus.py] 向量检索
    │      ↓
    ├─→ [Agent Manager] 自动路由
    │      ↓
    │   ┌──────────┬──────────┐
    │   ↓          ↓          ↓
    │ 通用Agent  天气Agent  其他Agent
    │   │          │          │
    │   ├─ 知识库  ├─ 时间解析  ...
    │   ├─ 计算器  ├─ 地点解析
    │   ├─ 百科    └─ 天气API
    │   └─ 网络搜索
    │      ↓
    └─→ [llm.py] 生成答案
    ↓
返回结构化结果
```

---

## 🎯 核心技术架构

### 后端技术栈

| 组件 | 技术 | 版本 | 用途 |
|------|------|------|------|
| Web框架 | FastAPI | - | 异步Web服务 |
| ORM | SQLAlchemy | 2.0+ | 数据库操作 |
| 数据库 | PostgreSQL | 16 | 结构化数据存储 |
| 缓存 | Redis | 7 | 会话和热数据缓存 |
| 向量数据库 | Milvus | 2.3+ | 语义检索 |
| LLM | Qwen3-8B (Ollama) | - | 对话生成 |
| Embedding | nomic-embed-text | - | 文本向量化 |
| Agent框架 | LangChain | - | Agent和工具管理 |
| 搜索引擎 | SearXNG | - | 网络搜索 |
| 日志 | Loguru | - | 日志管理 |

### 前端技术栈

| 组件 | 技术 | 版本 | 用途 |
|------|------|------|------|
| 框架 | Vue | 3.x | 响应式UI |
| UI库 | Element Plus | - | 组件库 |
| 构建工具 | Vite | - | 快速构建 |
| 路由 | Vue Router | 4.x | 单页应用路由 |
| HTTP客户端 | Axios | - | API请求 |

---

## 📈 系统特性

### 1. 多Agent架构 ⭐

- **AgentManager**: 自动路由到最合适的Agent
- **天气专家Agent**: 工具链串联（时间→地点→API）
- **通用助手Agent**: 知识库、计算、百科、网络搜索
- **易于扩展**: 可添加订单Agent、产品Agent等

### 2. 三级智能回退

1. **知识库优先** (置信度 ≥ 20%)
2. **网络搜索补充** (置信度 < 20%)
3. **通用AI兜底** (搜索无果)

### 3. 答案来源标识

- 🟢 知识库
- 🔵 网络搜索
- 🟡 AI推理
- 🟠 天气API

### 4. 问题历史缓存

- 浏览器LocalStorage存储最近10条问题
- 快速重新提问

---

## 🔍 日志查看

### 实时日志

```bash
tail -f logs/app_$(date +%Y-%m-%d).log
```

### 查看Agent路由

```bash
tail -f logs/app_*.log | grep "路由"
```

### 查看工具链执行

```bash
tail -f logs/app_*.log | grep "工具链"
```

---

## 📚 相关文档

- [需求文档](./需求文档.md) - 项目需求和技术选型
- [开发计划](./开发计划.md) - 开发阶段和进度
- [Agent使用指南](./Agent使用指南.md) - Agent架构详细说明
- [README](../README.md) - 快速入门指南

---

## 🎉 总结

本项目采用现代化的微服务架构，结合：
- **FastAPI** 提供高性能API
- **Vue 3** 构建现代化前端
- **Milvus** 实现语义检索
- **Ollama** 部署本地LLM
- **多Agent架构** 实现专业化问答
- **Docker** 统一部署环境

**特点**：
- ✅ 完全本地部署，无需外部API
- ✅ 模块化设计，易于扩展
- ✅ 多Agent协同，自动路由
- ✅ 完整的前后端分离
- ✅ 详细的日志和监控

**适用场景**：
- 企业客服系统
- 知识库问答
- 智能助手
- 文档检索

---

**更新时间**: 2025-10-21  
**维护者**: AI Lemo QA Team

